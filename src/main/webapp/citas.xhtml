<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="content">

        <style>
            /* <![CDATA[ */

            /* Ajustes Generales */
            body .ui-widget { font-size: 13px !important; }
            body .ui-button { font-size: 13px !important; padding: 0.3rem 0.8rem; }
            .field-label { font-weight: bold; color: #495057; }

            /* SOLUCIÓN AL TRASLAPE SUPERIOR */
            .card {
                background-color: #ffffff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-top: 20px; /* ESTO EVITA QUE SE PEGUE ARRIBA */
            }

            /* Scroll para laptops en el modal */
            .scroll-content {
                max-height: 60vh;
                overflow-y: auto;
                padding-right: 10px;
                overflow-x: hidden;
            }

            /* COLORES DEL CALENDARIO (Estados) */
            .cita-pendiente .fc-event-main { background-color: #FFC107 !important; color: #000 !important; }
            .cita-pendiente { border-color: #FFC107 !important; }

            .cita-confirmada .fc-event-main { background-color: #FD7E14 !important; color: #fff !important; }
            .cita-confirmada { border-color: #FD7E14 !important; }

            .cita-atendida .fc-event-main { background-color: #28A745 !important; color: #fff !important; }
            .cita-atendida { border-color: #28A745 !important; }

            .cita-cancelada .fc-event-main { background-color: #DC3545 !important; text-decoration: line-through; opacity: 0.7; }
            .cita-cancelada { border-color: #DC3545 !important; }

            .cita-reprogramada .fc-event-main { background-color: #0D6EFD !important; color: #fff !important; }
            .cita-reprogramada { border-color: #0D6EFD !important; }

            /* ]]> */
        </style>

        <script type="text/javascript">
            PrimeFaces.locales['es'] = {
                closeText: 'Cerrar', prevText: 'Anterior', nextText: 'Siguiente',
                monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                dayNamesMin: ['D', 'L', 'M', 'X', 'J', 'V', 'S'],
                weekHeader: 'Semana', firstDay: 1, isRTL: false, showMonthAfterYear: false, yearSuffix: '',
                timeOnlyTitle: 'Sólo hora', timeText: 'Tiempo', hourText: 'Hora', minuteText: 'Minuto', secondText: 'Segundo',
                currentText: 'Fecha actual', ampm: false, month: 'Mes', week: 'Semana', day: 'Día', allDayText: 'Todo el día'
            };
        </script>

        <h:form id="frmCitas">
            <p:growl id="msgCitas" showDetail="true" life="4000"/>

            <div class="card">
                <h3 style="margin-top:0">Agenda de Citas</h3>

                <p:toolbar style="margin-bottom: 10px; padding: 5px;">
                    <p:toolbarGroup>
                        <p:commandButton value="Agendar Nueva Cita" icon="pi pi-plus"
                                         action="#{citaBean.newEntity}"
                                         update=":dialogoGestion"
                                         oncomplete="PF('wdialogo').show()"
                                         styleClass="ui-button-success">
                            <p:resetInput target=":dialogoGestion" />
                        </p:commandButton>
                    </p:toolbarGroup>

                    <p:toolbarGroup align="right">
                        <span style="margin-right:15px; font-size: 0.9em;"><i class="pi pi-circle-fill" style="color:#FFC107"></i> Pendiente</span>
                        <span style="margin-right:15px; font-size: 0.9em;"><i class="pi pi-circle-fill" style="color:#28A745"></i> Atendida</span>
                        <span style="margin-right:15px; font-size: 0.9em;"><i class="pi pi-circle-fill" style="color:#DC3545"></i> Cancelada</span>
                    </p:toolbarGroup>
                </p:toolbar>

                <p:schedule id="calendario" value="#{citaBean.schedule}" widgetVar="miCalendario"
                            locale="es" timeZone="GMT-6"
                            height="auto"
                            view="timeGridWeek"
                            rightHeaderTemplate="dayGridMonth,timeGridWeek,timeGridDay,listYear">

                    <p:ajax event="eventSelect" listener="#{citaBean.onEventSelect}"
                            update=":dialogoGestion" oncomplete="PF('wdialogo').show();" />

                    <p:ajax event="dateSelect" listener="#{citaBean.onDateSelect}"
                            update=":dialogoGestion" oncomplete="PF('wdialogo').show();" />

                </p:schedule>
            </div>
        </h:form>

        <h:form>
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="300">
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
                <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes ui-button-danger" />
            </p:confirmDialog>
        </h:form>


        <p:dialog id="dialogoGestion" header="Detalles de la Cita" showEffect="fade" modal="true"
                  widgetVar="wdialogo" responsive="true" width="600" closeOnEscape="true"
                  appendTo="@(body)">

            <h:form id="frmDialogo">
                <div class="ui-fluid scroll-content">

                    <p:panelGrid columns="2" columnClasses="ui-grid-col-4 field-label, ui-grid-col-8"
                                 layout="grid" styleClass="ui-panelgrid-blank ui-fluid">

                        <p:outputLabel value="Código:" rendered="#{citaBean.selected.id != null}"/>
                        <p:inputText value="#{citaBean.selected.codigo}" readonly="true"
                                     rendered="#{citaBean.selected.id != null}" styleClass="ui-state-disabled"/>

                        <p:outputLabel value="Paciente:" for="paciente"/>
                        <p:selectOneMenu id="paciente" value="#{citaBean.selected.paciente}"
                                         required="true" filter="true" filterMatchMode="contains"
                                         converter="#{pacienteConverter}">
                            <f:selectItem itemLabel="Seleccione Paciente..." itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{citaBean.pacientes}" var="p"
                                           itemValue="#{p}"
                                           itemLabel="#{p.nombrePaciente} #{p.apellidoPaciente} (DPI: #{p.dpi})"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="Tratamiento:" for="tratamiento"/>
                        <p:selectOneMenu id="tratamiento" value="#{citaBean.selected.tratamiento}"
                                         required="true" filter="true" filterMatchMode="contains"
                                         converter="#{tratamientoConverter}">
                            <f:selectItem itemLabel="Seleccione Tratamiento..." itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{citaBean.tratamientos}" var="t"
                                           itemValue="#{t}" itemLabel="#{t.nombreTratamiento}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="Atendido por:" for="usuario"/>
                        <p:selectOneMenu id="usuario" value="#{citaBean.selected.user}"
                                         required="true" converter="#{userConverter}">
                            <f:selectItem itemLabel="Seleccione Doctor..." itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{citaBean.usuarios}" var="u"
                                           itemValue="#{u}" itemLabel="#{u.nombreUsuario} #{u.apellidoUsuario} (#{u.role_name})"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="Fecha y Hora:" for="fecha"/>
                        <p:datePicker id="fecha" value="#{citaBean.selected.fechaApertura}"
                                      showTime="true" stepMinute="15" pattern="dd/MM/yyyy HH:mm"
                                      locale="es" required="true" showIcon="false"
                                      mindate="#{citaBean.fechaMinima}"/>

                        <p:outputLabel value="Estado:" for="estado"/>
                        <p:selectOneMenu id="estado" value="#{citaBean.selected.estado_cita}" required="true">
                            <f:selectItems value="#{citaBean.estadosCita}" var="e" itemValue="#{e}" itemLabel="#{e}"/>
                        </p:selectOneMenu>

                        <p:outputLabel value="Observaciones:" for="obs"/>
                        <p:inputTextarea id="obs" value="#{citaBean.selected.observacionesCita}" rows="3" autoResize="false"/>

                    </p:panelGrid>
                </div>

                <p:separator style="margin: 10px 0" />

                <div style="display: flex; justify-content: space-between; align-items: center;">

                    <div>
                        <p:commandButton value="Cancelar Cita" icon="pi pi-trash"
                                         rendered="#{citaBean.selected.id != null}"
                                         action="#{citaBean.delete(citaBean.selected)}"
                                         update=":frmCitas:calendario, :frmCitas:msgCitas"
                                         styleClass="ui-button-danger ui-button-outlined">
                            <p:confirm header="Confirmar" message="¿Desea eliminar/cancelar esta cita?" icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                    </div>

                    <div>
                        <p:commandButton value="Cerrar" icon="pi pi-times"
                                         onclick="PF('wdialogo').hide()"
                                         styleClass="ui-button-secondary ui-button-flat"
                                         type="button" style="margin-right: 5px;"/>

                        <p:commandButton value="Guardar Cita" icon="pi pi-check"
                                         action="#{citaBean.save}"
                                         update=":frmCitas:calendario, :frmCitas:msgCitas"
                                         oncomplete="if(!args.validationFailed){PF('wdialogo').hide()}"/>
                    </div>
                </div>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>