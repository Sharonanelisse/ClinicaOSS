<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="content">

        <h2>Agenda de Citas</h2>

        <h:outputStylesheet>
            /* ---- Form grid responsive sin PrimeFlex ---- */
            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-column-gap: 1.25rem;
                grid-row-gap: .75rem;
            }
            .form-field {
                display: flex;
                flex-direction: column;
            }
            .form-field label {
                font-weight: 600;
                color: #495057;
                margin: 0 0 .25rem;
            }
            .form-field .w-full {
                width: 100%;
            }
            .form-field .ui-message,
            .form-field .p-message {
                margin: .25rem 0 0 0;
            }
            .form-footer {
                display: flex;
                justify-content: flex-end;
                gap: .5rem;
                margin-top: .75rem;
            }
            @media (max-width: 992px) {
                .form-grid { grid-template-columns: 1fr; }
            }
            .ui-dialog .ui-dialog-content {
                padding-top: .5rem;
            }
            .colLabel {
                width: 180px;
                padding: .5rem .75rem .25rem 0;
                text-align: right;
                vertical-align: top;
                white-space: nowrap;
                font-weight: 600;
                color: #495057;
            }
            .colField {
                width: 320px;
                padding: .25rem .75rem .5rem 0;
                vertical-align: top;
            }
            .w100 { width: 100%; }
            .fieldMsg .ui-message, .fieldMsg .p-message { margin:.25rem 0 0 0; }

            .toolbar {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 1rem;
            }
        </h:outputStylesheet>

        <h:form id="frmCitas">

            <div class="toolbar">
                <p:commandButton value="Nueva cita" icon="pi pi-plus"
                                 actionListener="#{citaBean.newEvent}"
                                 process="@this"
                                 update="dlgCita"
                                 resetValues="true"/>
            </div>

            <!-- CALENDARIO -->
            <p:schedule id="cal" value="#{citaBean.schedule}" widgetVar="sch"
                        locale="es" timeZone="GMT-6" allDaySlot="false"
                        view="dayGridMonth" style="height:600px">

                <p:ajax event="eventSelect"
                        listener="#{citaBean.onEventSelect}"
                        update="dlgDetail"/>

            </p:schedule>

            <!-- DIÁLOGO DETALLE -->
            <p:dialog id="dlgDetail" widgetVar="dlgDetail"
                      header="Detalle de la cita"
                      visible="#{citaBean.detailVisible}"
                      modal="true" width="600">

                <h:panelGrid columns="2" cellpadding="5">

                    <h:outputText value="Paciente:"/>
                    <h:outputText value="#{citaBean.selected.paciente.nombre}"/>

                    <h:outputText value="Fecha:"/>
                    <h:outputText value="#{citaBean.selected.fechaApertura}"/>

                    <h:outputText value="Estado:"/>
                    <h:outputText value="#{citaBean.selected.estado_cita}"/>

                    <h:outputText value="Tratamiento:"/>
                    <h:outputText value="#{citaBean.selected.tratamiento.nombre}"/>

                    <h:outputText value="Observaciones:"/>
                    <h:outputText value="#{citaBean.selected.observacionesCita}"/>
                </h:panelGrid>

                <f:facet name="footer">
                    <p:commandButton value="Editar" icon="pi pi-pencil"
                                     actionListener="#{citaBean.edit(citaBean.selected)}"
                                     update="dlgCita"
                                     oncomplete="PF('dlgDetail').hide(); PF('dlgCita').show();"/>

                    <p:commandButton value="Eliminar" icon="pi pi-trash"
                                     styleClass="ui-button-danger"
                                     actionListener="#{citaBean.delete}"
                                     update="cal"
                                     oncomplete="PF('dlgDetail').hide();"/>

                </f:facet>
            </p:dialog>

            <!-- DIÁLOGO FORMULARIO DE CITA -->
            <p:dialog id="dlgCita" widgetVar="dlgCita"
                      header="Registrar/Editar Cita"
                      visible="#{citaBean.dialogVisible}"
                      modal="true" width="650">

                <div class="form-grid">

                    <div class="form-field">
                        <label>Paciente *</label>
                        <p:selectOneMenu value="#{citaBean.cita.paciente}" styleClass="w-full"
                                         filter="true" filterMatchMode="contains">
                            <f:selectItem itemLabel="Seleccione..." itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{citaBean.pacientes}" var="p"
                                           itemValue="#{p}" itemLabel="#{p.nombre}"/>
                        </p:selectOneMenu>
                    </div>

                    <div class="form-field">
                        <label>Fecha *</label>
                        <p:datePicker value="#{citaBean.cita.fechaApertura}"
                                      showTime="true" hourFormat="24" pattern="yyyy-MM-dd HH:mm"
                                      styleClass="w-full"/>
                    </div>

                    <div class="form-field">
                        <label>Tratamiento *</label>
                        <p:selectOneMenu value="#{citaBean.cita.tratamiento}" styleClass="w-full">
                            <f:selectItems value="#{citaBean.tratamientos}" var="t"
                                           itemValue="#{t}" itemLabel="#{t.nombre}"/>
                        </p:selectOneMenu>
                    </div>

                    <div class="form-field">
                        <label>Estado</label>
                        <p:selectOneMenu value="#{citaBean.cita.estado_cita}" styleClass="w-full">
                            <f:selectItems value="#{citaBean.estadosCita}"/>
                        </p:selectOneMenu>
                    </div>

                    <div class="form-field" style="grid-column:1/span 2">
                        <label>Observaciones</label>
                        <p:inputTextarea value="#{citaBean.cita.observacionesCita}"
                                         rows="3" styleClass="w-full"/>
                    </div>
                </div>

                <f:facet name="footer">
                    <p:commandButton value="Guardar" icon="pi pi-check"
                                     actionListener="#{citaBean.save}"
                                     update="cal"
                                     oncomplete="PF('dlgCita').hide();"/>

                    <p:commandButton value="Cancelar" icon="pi pi-times"
                                     onclick="PF('dlgCita').hide(); return false;"
                                     styleClass="ui-button-secondary"/>
                </f:facet>

            </p:dialog>

        </h:form>
    </ui:define>
</ui:composition>
