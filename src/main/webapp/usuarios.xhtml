<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:define name="content">

        <style>
            body .ui-widget { font-size: 13px !important; }
            body .ui-inputfield { padding: 0.3rem 0.5rem; }
            body .ui-button { font-size: 13px !important; padding: 0.3rem 0.8rem; }

            .fila-desactivada {
                background-color: #f4f4f4 !important;
                color: #9e9e9e !important;
                font-style: italic;
            }

            /* Scroll para el diálogo en laptops */
            .scroll-content {
                max-height: 65vh;
                overflow-y: auto;
                overflow-x: hidden;
                padding-right: 10px;
            }
            .field-label { font-weight: bold; color: #495057; }
        </style>

        <h:form id="frmPrincipal">
            <p:growl id="msgGlobal" showDetail="true" life="4000" />

            <div class="card">
                <h3 style="margin-top:0">Gestión de Usuarios y Personal</h3>

                <p:toolbar style="margin-bottom: 10px; padding: 5px;">
                    <p:toolbarGroup>
                        <p:commandButton value="Nuevo Usuario" icon="pi pi-plus"
                                         action="#{usuarioBean.newEntity}"
                                         update=":dialogoGestion"
                                         oncomplete="PF('wdialogo').show()"
                                         styleClass="ui-button-success">
                            <p:resetInput target=":dialogoGestion" />
                        </p:commandButton>
                    </p:toolbarGroup>
                </p:toolbar>

                <p:dataTable id="tblUsuarios"
                             value="#{usuarioBean.list}"
                             var="u"
                             paginator="true"
                             rows="10"
                             size="small"
                             paginatorPosition="bottom"
                             rowKey="#{u.id}"
                             selectionMode="single"
                             selection="#{usuarioBean.selected}"
                             striped="true"
                             rowStyleClass="#{u.status ? null : 'fila-desactivada'}">

                    <p:column headerText="ID" width="40" style="text-align: center;">
                        <h:outputText value="#{u.id}" />
                    </p:column>

                    <p:column headerText="Nombre Completo" sortBy="#{u.apellidoUsuario}">
                        <h:outputText value="#{u.nombreUsuario} #{u.apellidoUsuario}" />
                    </p:column>

                    <p:column headerText="Rol" width="120" style="text-align: center;">
                        <p:tag value="#{u.role_name}" severity="info" style="font-weight:bold"/>
                    </p:column>

                    <p:column headerText="Email (Usuario)">
                        <h:outputText value="#{u.email}" />
                    </p:column>

                    <p:column headerText="Teléfono" width="100">
                        <h:outputText value="#{u.telefono}" />
                    </p:column>

                    <p:column headerText="Estado" width="90" style="text-align: center;">
                        <p:tag severity="#{u.status ? 'success' : 'danger'}" value="#{u.status ? 'Activo' : 'Inactivo'}"/>
                    </p:column>

                    <p:column headerText="Acciones" width="120" style="text-align: center;">

                        <p:commandButton icon="pi pi-pencil"
                                         action="#{usuarioBean.cargarUsuario(u)}"
                                         update=":dialogoGestion"
                                         process="@this"
                                         oncomplete="PF('wdialogo').show()"
                                         styleClass="rounded-button ui-button-flat ui-button-warning"
                                         disabled="#{!u.status}"
                                         title="Editar datos y horario">
                            <p:resetInput target=":dialogoGestion" />
                        </p:commandButton>

                        <p:commandButton icon="pi pi-ban"
                                         rendered="#{u.status}"
                                         action="#{usuarioBean.delete(u)}"
                                         update="tblUsuarios, :frmPrincipal:msgGlobal"
                                         styleClass="rounded-button ui-button-flat ui-button-danger"
                                         title="Desactivar acceso">
                            <p:confirm header="Confirmar" message="¿Desactivar este usuario?" icon="pi pi-exclamation-triangle" />
                        </p:commandButton>

                        <p:commandButton icon="pi pi-check-circle"
                                         rendered="#{!u.status}"
                                         action="#{usuarioBean.activar(u)}"
                                         update="tblUsuarios, :frmPrincipal:msgGlobal"
                                         styleClass="rounded-button ui-button-flat ui-button-success"
                                         title="Reactivar acceso">
                        </p:commandButton>
                    </p:column>
                </p:dataTable>
            </div>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="300">
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>
                <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes" />
            </p:confirmDialog>
        </h:form>

        <p:dialog id="dialogoGestion" header="Gestión de Usuario" showEffect="fade" modal="true"
                  widgetVar="wdialogo" responsive="true" width="700" closeOnEscape="true"
                  appendTo="@(body)"> <h:form id="frmDialogo">
            <div class="ui-fluid scroll-content">

                <p:tabView>

                    <p:tab title="Datos Generales">
                        <p:panelGrid columns="2" columnClasses="ui-grid-col-4 field-label, ui-grid-col-8"
                                     layout="grid" styleClass="ui-panelgrid-blank">

                            <p:outputLabel value="Nombre:" for="nom"/>
                            <p:inputText id="nom" value="#{usuarioBean.selected.nombreUsuario}" required="true"/>

                            <p:outputLabel value="Apellido:" for="ape"/>
                            <p:inputText id="ape" value="#{usuarioBean.selected.apellidoUsuario}" required="true"/>

                            <p:outputLabel value="Rol del Sistema:" for="rol"/>
                            <p:selectOneMenu id="rol" value="#{usuarioBean.selected.role_name}" required="true">
                                <f:selectItems value="#{usuarioBean.roles}" var="r" itemLabel="#{r}" itemValue="#{r}"/>
                            </p:selectOneMenu>

                            <p:outputLabel value="Email (Login):" for="mail"/>
                            <p:inputText id="mail" value="#{usuarioBean.selected.email}" required="true"/>

                            <p:outputLabel value="Teléfono:" for="tel"/>
                            <p:inputText id="tel" value="#{usuarioBean.selected.telefono}" required="true"/>

                            <p:outputLabel value="Contraseña:" for="pwd"/>
                            <p:password id="pwd" value="#{usuarioBean.selected.password}" toggleMask="true" redisplay="true"
                                        feedback="true" inline="true"
                                        placeholder="(Dejar igual si no cambia)"/>
                        </p:panelGrid>
                    </p:tab>

                    <p:tab title="Jornada Laboral" disabled="#{usuarioBean.selected.id == null}">

                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <h6 style="margin:0 0 10px 0; color:#495057;">Agregar Nuevo Horario</h6>
                            <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank ui-fluid">

                                <p:selectOneMenu value="#{usuarioBean.nuevaJornada.dia_semana}" placeholder="Día">
                                    <f:selectItems value="#{usuarioBean.diasSemana}" />
                                </p:selectOneMenu>

                                <p:datePicker value="#{usuarioBean.nuevaJornada.horaInicio}" timeOnly="true" pattern="HH:mm" placeholder="Entrada"/>
                                <p:datePicker value="#{usuarioBean.nuevaJornada.horaFin}" timeOnly="true" pattern="HH:mm" placeholder="Salida"/>

                                <p:commandButton icon="pi pi-plus"
                                                 action="#{usuarioBean.agregarJornada}"
                                                 update="tblJornadas, :frmPrincipal:msgGlobal"
                                                 styleClass="ui-button-secondary"/>
                            </p:panelGrid>
                        </div>

                        <p:dataTable id="tblJornadas" value="#{usuarioBean.jornadasUsuario}" var="j"
                                     size="small" emptyMessage="Este usuario no tiene horarios asignados.">

                            <p:column headerText="Día">
                                <h:outputText value="#{j.dia_semana}" style="font-weight:bold"/>
                            </p:column>

                            <p:column headerText="Horario">
                                <h:outputText value="#{j.horaInicio}">
                                    <f:convertDateTime pattern="HH:mm" type="localTime"/>
                                </h:outputText>
                                <h:outputText value=" - " />
                                <h:outputText value="#{j.horaFin}">
                                    <f:convertDateTime pattern="HH:mm" type="localTime"/>
                                </h:outputText>
                            </p:column>

                            <p:column style="width:50px; text-align: center;">
                                <p:commandButton icon="pi pi-trash"
                                                 action="#{usuarioBean.eliminarJornada(j)}"
                                                 update="tblJornadas, :frmPrincipal:msgGlobal"
                                                 styleClass="rounded-button ui-button-flat ui-button-danger ui-button-sm"/>
                            </p:column>
                        </p:dataTable>
                    </p:tab>

                </p:tabView>
            </div>

            <p:separator/>

            <div style="text-align: right;">
                <p:commandButton value="Cancelar" icon="pi pi-times" onclick="PF('wdialogo').hide()"
                                 styleClass="ui-button-secondary ui-button-outlined" style="margin-right: 10px;" immediate="true" />

                <p:commandButton value="Guardar Usuario" icon="pi pi-check" action="#{usuarioBean.save}"
                                 update=":frmPrincipal:tblUsuarios, :frmPrincipal:msgGlobal"
                                 oncomplete="if(!args.validationFailed){PF('wdialogo').hide()}" />
            </div>
        </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>